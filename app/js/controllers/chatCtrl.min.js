ChatApp.controller("chatCtrl",["$scope","$rootScope","$http","$state","$sessionStorage","$stateParams","$interval","$timeout","$mdToast","$anchorScroll","CONFIG",function(e,s,t,a,n,o,r,i,c,h,g){e.getUserData("chat"),e.messageData={message:"",fromUser:o.fromUserId,toUser:o.toUserId,senderName:n.userData.name,recieverName:n.recieverData.name,postedDate:new Date},e.getChatList=function(s){console.log("$stateParams",o),e.loading=!0;var a={fromUser:o.fromUserId,toUser:o.toUserId};t({method:"POST",url:g.rootUrl+"getChatList",headers:{"Content-Type":"application/json"},data:a}).then(function(s){if(e.loading=!1,1==s.data.success){if(s.data.chats.length>0){e.chatList=s.data.chats;var t=e.chatList.length-1,a=e.chatList[t];i(function(){h(a.msgId)},200)}}else e.msgContent="You have'nt sent any message to this person yet.",e.toasterClass="warningClass",e.showAlertMessage()})},e.getChatList(),e.sendMessage=function(s){var a=e.messageData;t({method:"POST",url:g.rootUrl+"senMessage",headers:{"Content-Type":"application/json"},data:e.messageData}).then(function(t){1==t.data.success&&(e.sendNotification(s,a),e.messageData.message="")})},e.sendNotification=function(e,s){var a={app_id:g.app_id,contents:{en:s.message},included_segments:["Active Users","Inactive Users"],url:"https://jaffarchatapp.github.io/jaffarChatApp/#!/home/chat/25sl29juhjxbima/vsncvm18d71z1x6"};t({method:"POST",url:g.notifyUrl,headers:{Authorization:g.REST_API_KEY,"Content-Type":"application/json"},data:a}).then(function(e){console.log("response",e)})},e.connectChatWs=function(){userMessages=new WebSocket(g.chatUrl);var s={fromUserId:o.fromUserId,toUserId:o.toUserId},t=JSON.stringify(s);userMessages.onopen=function(){userMessages.send(t)},userMessages.onmessage=function(s){var t=s.data,a=JSON.parse(t);e.chatList.push(a[0]);var n=e.chatList.length-1,o=e.chatList[n];i(function(){h(o.msgId)},200)},userMessages.onerror=function(e){},userMessages.onclose=function(){e.connectChatWs()}},i(function(){e.connectChatWs()},800),e.showAlertMessage=function(){c.show(c.simple().textContent(e.msgContent).position("top left").hideDelay(3e3).toastClass(e.toasterClass))},s.$on("$stateChangeStart",function(s,t,a,n,o){e.pageChanged=!0,userMessages.close(),console.log("userMessages",userMessages)})}]);
